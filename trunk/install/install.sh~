#!/bin/bash

##
# Application requirements
##

# Required packages
echo "Required packages...";
apt-get install \
	makepasswd \
	mysql-server \
	apache2-mpm-worker libapache2-mod-fastcgi \
	php5-fpm php5-cli php-apc php5-mcrypt php5-mysql php-pear
a2enmod actions
a2enmod ssl
a2enmod fastcgi
a2enmod rewrite

# Directories
echo "Directory structure..."
mkdir /home/siteadm_admin
mkdir /home/siteadm/ /home/siteadm/common /home/siteadm_domain /home/siteadm_website /home/siteadm_email
chown root:root /home/siteadm_admin
chmod 755 /home/siteadm_admin

# Siteadm user, group and sudo
echo "Users ans groups..."
groupadd -g 502 siteadm
useradd -g 502 -u 502 -d /home/siteadm_admin siteadm
groupadd -g 2000 siteadm_user
useradd -g 2000 -u 2000 -d /home/siteadm/common siteadm_common
useradd -g 2000 -u 3000 -d /home/siteadm/common php_common

# MySQL user
echo "MySQL configuration..."
mysql -uroot -p siteadm < mysql/siteadm.sql

# PHP-FPM
rm /etc/init.d/php5-siteadm
ln -s /home/siteadm_admin/conf/php/php5-siteadm /etc/init.d/
update-rc.d -n php5-siteadm defaults
service php5-siteadm start

###
# OTHER USEFULL PACKAGES
###

# PHP
apt-get install php5-gd

# Apache
echo "Apache configuration..."
rm /etc/apache2/sites-available/siteadm.conf
ln -s /home/siteadm_admin/apache/siteadm.conf /etc/apache2/sites-available/
a2ensite siteadm
mkdir /etc/apache2/sites-siteadm
echo "Include sites-siteadm/" >> /etc/apache2/apache2.conf
service apache2 restart

# ProftpD
apt-get install proftpd-mod-mysql

# Postfix
apt-get install postfix-mysql

# Dovecot
apt-get install dovecot-mysql dovecot-imapd dovecot-pop3d dovecot-postfix dovecot-sieve dovecot-antispam

# Spamassassin
apt-get install spamassassin

# clamav
apt-get install clamav-daemon

# Amavis
apt-get install amavisd-new amavisd-new-postfix

###
# Initialisation Script
###

cd /home/siteadm_admin/scripts/
php db_object.psh account 1 insert
